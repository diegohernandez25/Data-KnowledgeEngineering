{% extends "base.html" %}

{% block content %}

    <div class="container-fluid" style="padding-left: 225px">

        <div class="row">
            <div id="map" class="col-sm-9"></div>
            <div class="col-sm-3" style="padding-top: 2%">
                {% block contentbar %}
                {% endblock %}
            </div>
        </div>
        <script src="https://api-maps.yandex.ru/2.1/?lang=en_RU&amp;apikey=<your API-key>"
                type="text/javascript"></script>
        <script src="icon_customImage.js" type="text/javascript"></script>
        <style>
            #map {
                width: 100%;
                height: 100vh;
            }
        </style>


        <script>
            ymaps.ready(init);
            var map;
            var lst = [];
            lstPMarks = [];
            lstRoutes = [];

            function init() {
                map = new ymaps.Map("map", {
                    center: [50, 20],
                    zoom: 4
                });
                 place();
              /*  map.events.add('click', function (e) {
                    if (map.geoObjects.getLength()>0)
                        map.geoObjects.removeAll()
                    var coords = e.get('coords');
                    var placemark = new ymaps.Placemark(coords,
                        {}, {
                            iconLayout: 'default#image',
                            iconImageHref: '/static/assets/aeroplane.png',
                            // The size of the placemark.
                            iconImageSize: [35, 42],
                            iconImageOffset: [-17.5, -42]
                        });
                    map.geoObjects.add(placemark);
                });*/
            }


            function recenter() {
                map.setCenter([50, 20]);
                map.setZoom(4);
            }
            function centerCamera(lat,lon){
                map.setCenter([lat,lon]);
                console.log("Map centered")
            }
            function zoomCamera(){
                map.setZoom(12);
                console.log("Map zoomed")
            }
            function addPlacemark(lat, long, iata, airport, info, flag) {
                console.log("addplacemark");
                if (!lst.includes(iata) || !flag) {
                    var placemark = new ymaps.Placemark([lat, long],
                        {
                            hintContent: airport,
                            balloonContent: info
                        }, {
                            /**
                             * Options.
                             * You must specify this type of layout.
                             */
                            iconLayout: 'default#image',
                            // Custom image for the placemark icon.

                            iconImageHref: '/static/assets/aeroplane.png',
                            // The size of the placemark.
                            iconImageSize: [35, 42],
                            /**
                             * The offset of the upper left corner of the icon relative
                             * to its "tail" (the anchor point).
                             */
                            iconImageOffset: [-17.5, -21]
                        });
                    map.geoObjects.add(placemark);
                    lst.push(iata)
                    if (flag)
                        lstPMarks.push([lat, long, iata, airport, info]);
                }
            }
            function addPlacemarkTourist(lat, long, iata, airport, info, flag) {
                console.log("addplacemark");
                if (!lst.includes(iata) || !flag) {
                    var placemark = new ymaps.Placemark([lat, long],
                        {
                            hintContent: airport,
                            balloonContent: info
                        }, {
                            /**
                             * Options.
                             * You must specify this type of layout.
                             */
                            iconLayout: 'default#image',
                            // Custom image for the placemark icon.

                            iconImageHref: '/static/assets/map_select.png',
                            // The size of the placemark.
                            iconImageSize: [35, 42],
                            /**
                             * The offset of the upper left corner of the icon relative
                             * to its "tail" (the anchor point).
                             */
                            iconImageOffset: [-17.5, -21]
                        });
                    map.geoObjects.add(placemark);
                    lst.push(iata)
                    if (flag)
                        lstPMarks.push([lat, long, iata, airport, info]);
                }
            }

            function drawRoutes(route, srcName, dstName, srcLat, srcLong, dstLat, dstLong, flag) {
                var recLevel = Math.floor(Math.log2(distance(srcLat, srcLong, dstLat, dstLong))) + 1;
                if (recLevel < 3)
                    recLevel++;
                rec(route, srcName, dstName, srcLat, srcLong, dstLat, dstLong, recLevel);
                if (flag)
                    lstRoutes.push([route, srcName, dstName, srcLat, srcLong, dstLat, dstLong]);
            }

            function rec(route, srcName, dstName, srcLat, srcLong, dstLat, dstLong, level) {
                var midpoint = calcMidPoint(srcLat, srcLong, dstLat, dstLong);
                if (level == 0)
                    placeMidPoint(route, srcName, dstName, midpoint)
                else {
                    rec(route, srcName, dstName, srcLat, srcLong, midpoint[0], midpoint[1], level - 1);
                    rec(route, srcName, dstName, midpoint[0], midpoint[1], dstLat, dstLong, level - 1);
                }
            }

            function placeMidPoint(route, srcName, dstName, point) {
                var placemark = new ymaps.Placemark(point,
                    {
                        hintContent: "Route " + route,
                        balloonContent: "Route between " + srcName + " and " + dstName
                    },
                    {
                        iconLayout: 'default#image',
                        iconImageHref: '/static/assets/red_dot.png',
                        iconImageSize: [4, 4],
                        iconImageOffset: [-2, -2]
                    });
                map.geoObjects.add(placemark);
            }

            function distance(srcLat, srcLong, dstLat, dstLong) {
                var lat = srcLat - dstLat;
                var long = srcLong - dstLong;
                return Math.sqrt(lat * lat + long * long);
            }

            function calcMidPoint(srcLat, srcLong, dstLat, dstLong) {
                var lat = (srcLat + dstLat) / 2;
                var long = (srcLong + dstLong) / 2;
                return [lat, long];
            }

            function removePlacemarks() {
                map.geoObjects.removeAll();
            }

            function resetPlacemarks() {
                map.geoObjects.removeAll();
                for (i = 0; i < lstPMarks.length; i++) {
                    addPlacemark(lstPMarks[i][0], lstPMarks[i][1], lstPMarks[i][2], lstPMarks[i][3], lstPMarks[i][4], false);
                }
                for (i = 0; i < lstRoutes.length; i++) {
                    drawRoutes(lstRoutes[i][0], lstRoutes[i][1], lstRoutes[i][2], lstRoutes[i][3], lstRoutes[i][4], lstRoutes[i][5], lstRoutes[i][6], false);
                }
            }

            function addTerritorialRoute(origin_lat, origin_lon, destiny_lat, destiny_lon,origin_lat2, origin_lon2, destiny_lat2, destiny_lon2){
                var multiRoute = new ymaps.multiRouter.MultiRoute({
                        // The description of the reference points on the multi-stop route.
                        referencePoints: [
                            [origin_lat,origin_lon],
                            [destiny_lat,destiny_lon]
                        ],
                        // Routing options.
                        params: {
                            // Limit on the maximum number of routes returned by the router.
                            results: 2
                        }
                    }, {
                        // Automatically set the map boundaries so the entire route is visible.
                        boundsAutoApply: true
                    });
                    var multiRoute2 = new ymaps.multiRouter.MultiRoute({
                            // The description of the reference points on the multi-stop route.
                            referencePoints: [
                                [origin_lat2,origin_lon2],
                                [destiny_lat2,destiny_lon2]
                            ],
                            // Routing options.
                            params: {
                                // Limit on the maximum number of routes returned by the router.
                                results: 2
                            }
                        }, {
                            // Automatically set the map boundaries so the entire route is visible.
                            boundsAutoApply: true
                        });

                map.geoObjects.add( multiRoute);
                map.geoObjects.add( multiRoute2);
            }



        </script>
    </div>
{% endblock %}
